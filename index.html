<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英语听写助手 (译林版 4A 全册)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0fdf4; /* Green-50 */
        }
        .btn-primary {
            @apply bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-200 ease-in-out transform hover:-translate-y-1 flex items-center justify-center gap-2;
        }
        .btn-secondary {
            @apply bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-400 rounded shadow transition duration-200;
        }
        .btn-danger {
            @apply bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded shadow transition duration-200;
        }
        .btn-warning {
             @apply bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded shadow transition duration-200;
        }
        .card {
            @apply bg-white rounded-xl shadow-md overflow-hidden p-6 border border-gray-100;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
        }
        /* Pulse animation for the active playing icon */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(1.2); opacity: 0; }
        }
        .playing-indicator::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: #16a34a;
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            z-index: -1;
        }
        select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="max-w-md w-full space-y-6">
        
        <!-- Header -->
        <div class="text-center space-y-2">
            <h1 class="text-3xl font-extrabold text-green-800 tracking-tight">
                <i class="fas fa-headphones-alt mr-2"></i>英语听写助手
            </h1>
            <p class="text-green-600 text-sm">译林版 4A Unit 1-8 (含句型)</p>
        </div>

        <!-- Settings Card -->
        <div class="card space-y-4">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold text-gray-700">听写设置</h2>
                <!-- Word Count Selector -->
                <div class="flex items-center gap-2">
                    <label for="itemCountSelect" class="text-xs text-gray-500">数量:</label>
                    <select id="itemCountSelect" class="text-sm bg-gray-100 border-gray-200 rounded focus:ring-green-500 py-1 pl-2 pr-6">
                        <option value="10">10个</option>
                        <option value="20">20个</option>
                        <option value="30">30个</option>
                        <option value="40">40个</option>
                        <option value="50">50个</option>
                        <option value="60" selected>60个</option>
                        <option value="80">80个</option>
                        <option value="100">100个</option>
                    </select>
                </div>
            </div>
            
            <div class="flex flex-col gap-3">
                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-50 transition">
                    <input type="radio" name="mode" value="en" checked class="form-radio text-green-600 h-5 w-5">
                    <div>
                        <span class="font-medium text-gray-800">读英文 (美式)</span>
                        <p class="text-xs text-gray-500">报单词/句子，默写中文意思</p>
                    </div>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-50 transition">
                    <input type="radio" name="mode" value="zh" class="form-radio text-green-600 h-5 w-5">
                    <div>
                        <span class="font-medium text-gray-800">读中文 (普通话)</span>
                        <p class="text-xs text-gray-500">报意思，默写英文</p>
                    </div>
                </label>
                <label class="flex items-center space-x-3 cursor-pointer p-2 rounded hover:bg-gray-50 transition bg-green-50 border border-green-100">
                    <input type="radio" name="mode" value="mixed" class="form-radio text-green-600 h-5 w-5">
                    <div>
                        <span class="font-medium text-green-800">混合模式 (穿插)</span>
                        <p class="text-xs text-green-600">随机读英文或中文</p>
                    </div>
                </label>
            </div>

            <!-- Voice Selection -->
            <div class="border-t pt-3 space-y-3">
                <div class="text-sm font-semibold text-gray-700 mb-1">语音包选择</div>
                
                <div class="space-y-2">
                    <div class="flex flex-col text-xs text-gray-600">
                        <label for="enVoiceSelect" class="mb-1">英文发音:</label>
                        <select id="enVoiceSelect" class="w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg p-2 focus:ring-green-500 focus:border-green-500 truncate">
                            <option value="">自动选择 (美式)</option>
                        </select>
                    </div>
                    <div class="flex flex-col text-xs text-gray-600">
                        <label for="zhVoiceSelect" class="mb-1">中文发音:</label>
                        <select id="zhVoiceSelect" class="w-full bg-gray-50 border border-gray-300 text-gray-900 rounded-lg p-2 focus:ring-green-500 focus:border-green-500 truncate">
                            <option value="">自动选择 (普通话)</option>
                        </select>
                    </div>
                </div>
                <div class="text-right">
                     <button id="testVoiceBtn" class="text-xs bg-green-100 hover:bg-green-200 text-green-800 py-1 px-3 rounded transition">
                        <i class="fas fa-volume-up"></i> 试听当前语音
                    </button>
                </div>
            </div>

            <!-- Error List Status -->
            <div class="border-t pt-3 flex justify-between items-center text-sm">
                <div class="text-gray-600">
                    <i class="fas fa-book-dead text-red-500 mr-1"></i>
                    错题本: <span id="errorCount" class="font-bold text-red-600">0</span> 个
                </div>
                <button id="clearErrorsBtn" class="text-xs text-gray-400 hover:text-red-500 underline">
                    清空错题
                </button>
            </div>

            <div id="voiceStatus" class="text-xs text-orange-500 hidden">
                正在加载语音库...
            </div>
        </div>

        <!-- Control Panel -->
        <div id="controlPanel" class="grid grid-cols-1 gap-4">
            <button id="startBtn" class="btn-primary w-full text-lg">
                <i class="fas fa-play"></i> 开始新听写
            </button>
            
            <div id="activeControls" class="hidden space-y-3">
                
                <!-- Navigation & Pause Row -->
                <div class="grid grid-cols-4 gap-2">
                     <button id="prevBtn" class="col-span-1 btn-secondary flex items-center justify-center text-sm px-2">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button id="pauseBtn" class="col-span-2 btn-secondary flex items-center justify-center gap-2">
                        <i class="fas fa-pause"></i> 暂停
                    </button>
                    <button id="nextBtn" class="col-span-1 btn-secondary flex items-center justify-center text-sm px-2">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>

                <!-- Mark Error -->
                <button id="markErrorBtn" class="w-full btn-warning flex items-center justify-center gap-2 text-lg py-3 shadow-amber-200">
                    <i class="far fa-frown"></i> 太难了 / 记不住
                </button>

                <!-- Stop Button -->
                <button id="stopBtn" class="btn-danger w-full flex items-center justify-center gap-2">
                    <i class="fas fa-stop"></i> 结束听写
                </button>
            </div>
        </div>

        <!-- Playing Status -->
        <div id="statusArea" class="hidden card bg-green-50 border-green-200 text-center space-y-4 relative">
            <div class="absolute top-2 right-2">
                <div id="playingIcon" class="hidden relative w-3 h-3 bg-green-600 rounded-full playing-indicator"></div>
            </div>

            <div class="space-y-1">
                <p class="text-gray-500 text-sm uppercase tracking-wide">Current Progress</p>
                <p id="progressText" class="text-4xl font-bold text-green-700">1 / 60</p>
            </div>

            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-300">
                <div id="progressBar" class="bg-green-600 h-2.5 rounded-full progress-bar-fill" style="width: 0%"></div>
            </div>

            <div class="pt-2 text-gray-600 min-h-[1.5rem]" id="statusMessage">
                准备开始...
            </div>
        </div>

        <!-- History/Word List -->
        <div class="text-center">
            <button id="toggleListBtn" class="text-sm text-green-600 hover:text-green-800 underline">
                查看本次内容表 (听写后对答案)
            </button>
        </div>

        <div id="wordListArea" class="hidden card max-h-60 overflow-y-auto">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-50 text-gray-600 font-semibold">
                    <tr>
                        <th class="p-2">No.</th>
                        <th class="p-2">Unit</th>
                        <th class="p-2">English</th>
                        <th class="p-2">中文</th>
                        <th class="p-2 w-10">状态</th>
                    </tr>
                </thead>
                <tbody id="wordListBody" class="divide-y divide-gray-100">
                    <!-- Populated by JS -->
                </tbody>
            </table>
        </div>

    </div>

    <!-- Data Source -->
    <script>
        // Updated Vocabulary from Unit 1-8 including Sentences with Unit tags
        const fullVocabulary = [
            // --- Unit 1 ---
            { unit: "U1", en: "Maths", zh: "数学" },
            { unit: "U1", en: "Chinese", zh: "语文；中国的" },
            { unit: "U1", en: "PE", zh: "体育" },
            { unit: "U1", en: "timetable", zh: "课程表" },
            { unit: "U1", en: "English", zh: "英语" },
            { unit: "U1", en: "Science", zh: "科学" },
            { unit: "U1", en: "mouse", zh: "鼠标；老鼠" },
            { unit: "U1", en: "interesting", zh: "有趣的" },
            { unit: "U1", en: "Art", zh: "美术" },
            { unit: "U1", en: "subject", zh: "学科" },
            { unit: "U1", en: "read", zh: "阅读" },
            { unit: "U1", en: "number", zh: "数字" },
            { unit: "U1", en: "Music", zh: "音乐" },
            { unit: "U1", en: "best", zh: "最" },
            { unit: "U1", en: "all", zh: "全部" },
            { unit: "U1", en: "IT", zh: "信息科技" },
            { unit: "U1", en: "also", zh: "也" },
            { unit: "U1", en: "playground", zh: "操场" },
            { unit: "U1", en: "story", zh: "故事" },
            { unit: "U1", en: "culture", zh: "文化" },
            { unit: "U1", en: "welcome back to", zh: "欢迎回到" },
            { unit: "U1", en: "What subject do you like best?", zh: "你最喜欢什么学科？" },
            { unit: "U1", en: "I like Music best.", zh: "我最喜欢音乐。" },
            { unit: "U1", en: "It's time for IT.", zh: "该上信息科技课了。" },
            { unit: "U1", en: "Welcome back to school, class.", zh: "欢迎回到学校，同学们。" },
            { unit: "U1", en: "We have Chinese, Maths, English and Science.", zh: "我们有语文、数学、英语和科学课。" },
            { unit: "U1", en: "I'm good at Maths.", zh: "我擅长数学。" },

            // --- Unit 2 ---
            { unit: "U2", en: "day", zh: "一天" },
            { unit: "U2", en: "wash", zh: "洗" },
            { unit: "U2", en: "face", zh: "脸" },
            { unit: "U2", en: "have", zh: "吃；喝；有" },
            { unit: "U2", en: "early", zh: "早" },
            { unit: "U2", en: "thirty", zh: "三十" },
            { unit: "U2", en: "first", zh: "首先" },
            { unit: "U2", en: "twenty", zh: "二十" },
            { unit: "U2", en: "class", zh: "课" },
            { unit: "U2", en: "eleven", zh: "十一" },
            { unit: "U2", en: "fifteen", zh: "十五" },
            { unit: "U2", en: "dinner", zh: "晚餐" },
            { unit: "U2", en: "breakfast", zh: "早餐" },
            { unit: "U2", en: "lunch", zh: "午餐" },
            { unit: "U2", en: "bed", zh: "床" },
            { unit: "U2", en: "get up", zh: "起床" },
            { unit: "U2", en: "go to bed", zh: "上床睡觉" },
            { unit: "U2", en: "What time is it now?", zh: "现在几点了？" },
            { unit: "U2", en: "It's seven thirty.", zh: "现在七点半。" },
            { unit: "U2", en: "Hurry up!", zh: "赶紧！" },
            { unit: "U2", en: "It's time for lunch.", zh: "到吃午餐的时间了。" },
            { unit: "U2", en: "It's time to go to bed.", zh: "到睡觉的时间了。" },

            // --- Unit 3 ---
            { unit: "U3", en: "week", zh: "周" },
            { unit: "U3", en: "Monday", zh: "星期一" },
            { unit: "U3", en: "Tuesday", zh: "星期二" },
            { unit: "U3", en: "Wednesday", zh: "星期三" },
            { unit: "U3", en: "Thursday", zh: "星期四" },
            { unit: "U3", en: "Friday", zh: "星期五" },
            { unit: "U3", en: "Saturday", zh: "星期六" },
            { unit: "U3", en: "Sunday", zh: "星期天" },
            { unit: "U3", en: "up", zh: "起床；向上" },
            { unit: "U3", en: "free", zh: "空闲的" },
            { unit: "U3", en: "when", zh: "什么时候" },
            { unit: "U3", en: "today", zh: "今天" },
            { unit: "U3", en: "cinema", zh: "电影院" },
            { unit: "U3", en: "dancing", zh: "跳舞" },
            { unit: "U3", en: "every", zh: "每个" },
            { unit: "U3", en: "walk", zh: "走；遛" },
            { unit: "U3", en: "tomorrow", zh: "明天" },
            { unit: "U3", en: "lesson", zh: "一节课" },
            { unit: "U3", en: "make a schedule", zh: "制定计划表" },
            { unit: "U3", en: "When do you get up every day?", zh: "你每天什么时候起床？" },
            { unit: "U3", en: "What day is it today?", zh: "今天星期几？" },
            { unit: "U3", en: "I can't be late for school again!", zh: "我再也不能上学迟到了！" },
            { unit: "U3", en: "I have two dancing lessons every week.", zh: "我每周有两节舞蹈课。" },

            // --- Unit 4 ---
            { unit: "U4", en: "football", zh: "足球" },
            { unit: "U4", en: "basketball", zh: "篮球" },
            { unit: "U4", en: "ping-pong", zh: "乒乓球" },
            { unit: "U4", en: "play", zh: "玩；参加(运动)" },
            { unit: "U4", en: "great", zh: "非常的；很棒" },
            { unit: "U4", en: "well", zh: "好" },
            { unit: "U4", en: "try", zh: "试" },
            { unit: "U4", en: "keep fit", zh: "保持健康" },
            { unit: "U4", en: "have a go", zh: "试一试" },
            { unit: "U4", en: "What sport do you like?", zh: "你喜欢什么运动？" },
            { unit: "U4", en: "I like playing ping-pong.", zh: "我喜欢打乒乓球。" },
            { unit: "U4", en: "Come and play with us!", zh: "来和我们一起玩吧！" },
            { unit: "U4", en: "Can we play again tomorrow?", zh: "明天我们还能再玩吗？" },
            { unit: "U4", en: "I am good at playing basketball.", zh: "我擅长打篮球。" },

            // --- Unit 5 ---
            { unit: "U5", en: "hair", zh: "头发" },
            { unit: "U5", en: "eye", zh: "眼睛" },
            { unit: "U5", en: "ear", zh: "耳朵" },
            { unit: "U5", en: "nose", zh: "鼻子" },
            { unit: "U5", en: "mouth", zh: "嘴巴" },
            { unit: "U5", en: "arm", zh: "手臂" },
            { unit: "U5", en: "leg", zh: "腿" },
            { unit: "U5", en: "robot", zh: "机器人" },
            { unit: "U5", en: "doll", zh: "玩具娃娃" },
            { unit: "U5", en: "small", zh: "小的" },
            { unit: "U5", en: "same", zh: "相同的" },
            { unit: "U5", en: "different", zh: "不同的" },
            { unit: "U5", en: "puppet", zh: "木偶" },
            { unit: "U5", en: "Her eyes are black.", zh: "她的眼睛是黑色的。" },
            { unit: "U5", en: "His nose is small, but his mouth is big.", zh: "他的鼻子小但是嘴巴大。" },
            { unit: "U5", en: "His arms and legs are long.", zh: "他的手臂和腿很长。" },
            { unit: "U5", en: "Let's have a puppet show!", zh: "让我们举办一场木偶表演秀吧！" },

            // --- Unit 6 ---
            { unit: "U6", en: "weather", zh: "天气" },
            { unit: "U6", en: "cloudy", zh: "多云的" },
            { unit: "U6", en: "cool", zh: "凉爽的" },
            { unit: "U6", en: "rainy", zh: "多雨的" },
            { unit: "U6", en: "windy", zh: "多风的" },
            { unit: "U6", en: "warm", zh: "温暖的" },
            { unit: "U6", en: "sunny", zh: "晴朗的" },
            { unit: "U6", en: "hot", zh: "热的" },
            { unit: "U6", en: "umbrella", zh: "雨伞" },
            { unit: "U6", en: "park", zh: "公园" },
            { unit: "U6", en: "fly a kite", zh: "放风筝" },
            { unit: "U6", en: "What's the weather like today?", zh: "今天天气怎么样？" },
            { unit: "U6", en: "It's sunny and warm.", zh: "天气晴朗且温暖。" },
            { unit: "U6", en: "Don't worry. I have an umbrella.", zh: "别担心，我带了把雨伞。" },
            { unit: "U6", en: "Let's go to the park.", zh: "我们去公园吧。" },

            // --- Unit 7 ---
            { unit: "U7", en: "season", zh: "季节" },
            { unit: "U7", en: "spring", zh: "春天" },
            { unit: "U7", en: "summer", zh: "夏天" },
            { unit: "U7", en: "autumn", zh: "秋天" },
            { unit: "U7", en: "winter", zh: "冬天" },
            { unit: "U7", en: "ice cream", zh: "冰淇淋" },
            { unit: "U7", en: "cold", zh: "寒冷的" },
            { unit: "U7", en: "plant", zh: "种植" },
            { unit: "U7", en: "snow", zh: "雪" },
            { unit: "U7", en: "pick", zh: "采摘" },
            { unit: "U7", en: "go boating", zh: "去划船" },
            { unit: "U7", en: "go swimming", zh: "去游泳" },
            { unit: "U7", en: "go climbing", zh: "去爬山" },
            { unit: "U7", en: "go skating", zh: "去溜冰" },
            { unit: "U7", en: "In spring, it is warm.", zh: "在春天，天气温暖。" },
            { unit: "U7", en: "We plant trees.", zh: "我们种树。" },
            { unit: "U7", en: "In summer, it is hot.", zh: "在夏天，天气炎热。" },
            { unit: "U7", en: "We eat ice cream.", zh: "我们吃冰淇淋。" },
            { unit: "U7", en: "In winter, it is cold.", zh: "在冬天，天气寒冷。" },
            { unit: "U7", en: "We play in the snow.", zh: "我们在雪里玩耍。" },

            // --- Unit 8 ---
            { unit: "U8", en: "holiday", zh: "假期" },
            { unit: "U8", en: "clothes", zh: "衣服" },
            { unit: "U8", en: "wear", zh: "穿；戴" },
            { unit: "U8", en: "whose", zh: "谁的" },
            { unit: "U8", en: "skirt", zh: "半身裙" },
            { unit: "U8", en: "trousers", zh: "裤子" },
            { unit: "U8", en: "dress", zh: "连衣裙" },
            { unit: "U8", en: "sunglasses", zh: "太阳镜" },
            { unit: "U8", en: "coat", zh: "外套" },
            { unit: "U8", en: "shirt", zh: "衬衫" },
            { unit: "U8", en: "gloves", zh: "手套" },
            { unit: "U8", en: "at Chinese New Year", zh: "在春节" },
            { unit: "U8", en: "Whose trousers are these?", zh: "这些是谁的裤子？" },
            { unit: "U8", en: "They're my father's.", zh: "它们是我爸爸的。" },
            { unit: "U8", en: "I wear sunglasses because they're cool.", zh: "我戴太阳镜因为它们很酷。" },
            { unit: "U8", en: "Whose skirt is this?", zh: "这是谁的裙子？" },
            { unit: "U8", en: "We like wearing red clothes at Chinese New Year.", zh: "我们喜欢在春节穿红衣服。" }
        ];

        // State variables
        let currentList = [];
        let currentIndex = 0;
        let repeatCount = 0;
        let isPaused = false;
        let isPlaying = false;
        let dictationMode = 'en'; 
        let timeoutIds = [];
        let synth = window.speechSynthesis;
        let voices = [];
        let errorList = []; 
        window.speechUtterances = [];

        // Constants - Updated dynamically
        const REPEATS = 3;
        const INTERVAL_NEXT = 2000;   

        // DOM Elements
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const stopBtn = document.getElementById('stopBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const markErrorBtn = document.getElementById('markErrorBtn');
        const activeControls = document.getElementById('activeControls');
        const statusArea = document.getElementById('statusArea');
        const progressText = document.getElementById('progressText');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const playingIcon = document.getElementById('playingIcon');
        const wordListArea = document.getElementById('wordListArea');
        const wordListBody = document.getElementById('wordListBody');
        const toggleListBtn = document.getElementById('toggleListBtn');
        const voiceStatus = document.getElementById('voiceStatus');
        const errorCountEl = document.getElementById('errorCount');
        const clearErrorsBtn = document.getElementById('clearErrorsBtn');
        const enVoiceSelect = document.getElementById('enVoiceSelect');
        const zhVoiceSelect = document.getElementById('zhVoiceSelect');
        const testVoiceBtn = document.getElementById('testVoiceBtn');
        const itemCountSelect = document.getElementById('itemCountSelect');

        // Initialization
        startBtn.addEventListener('click', startDictation);
        stopBtn.addEventListener('click', stopDictation);
        pauseBtn.addEventListener('click', togglePause);
        prevBtn.addEventListener('click', () => navigate(-1));
        nextBtn.addEventListener('click', () => navigate(1));
        markErrorBtn.addEventListener('click', markCurrentAsError);
        clearErrorsBtn.addEventListener('click', clearErrorList);
        testVoiceBtn.addEventListener('click', testSelectedVoices);
        toggleListBtn.addEventListener('click', () => {
            wordListArea.classList.toggle('hidden');
        });

        // Load errors from LocalStorage
        function loadErrors() {
            const stored = localStorage.getItem('dictation_error_list');
            if (stored) {
                try {
                    errorList = JSON.parse(stored);
                } catch (e) {
                    console.error("Error parsing stored errors", e);
                    errorList = [];
                }
            } else {
                errorList = [];
            }
            updateErrorUI();
        }

        function saveErrors() {
            localStorage.setItem('dictation_error_list', JSON.stringify(errorList));
            updateErrorUI();
        }

        function updateErrorUI() {
            errorCountEl.innerText = errorList.length;
        }

        function clearErrorList() {
            if(confirm("确定要清空错题本吗？")) {
                errorList = [];
                saveErrors();
            }
        }

        // Voice Loading Logic
        function loadVoices() {
            voices = synth.getVoices();
            
            // Populate Dropdowns
            enVoiceSelect.innerHTML = '<option value="">自动选择 (美式优先)</option>';
            zhVoiceSelect.innerHTML = '<option value="">自动选择 (普通话优先)</option>';

            const enVoices = voices.filter(v => v.lang.startsWith('en'));
            const zhVoices = voices.filter(v => v.lang.startsWith('zh'));

            enVoices.forEach((v, i) => {
                const opt = document.createElement('option');
                opt.value = v.name;
                opt.textContent = `${v.name} (${v.lang})`;
                enVoiceSelect.appendChild(opt);
            });

            zhVoices.forEach((v, i) => {
                const opt = document.createElement('option');
                opt.value = v.name;
                opt.textContent = `${v.name} (${v.lang})`;
                zhVoiceSelect.appendChild(opt);
            });

            if (voices.length > 0) {
                const zhVoice = voices.find(v => v.lang.includes('zh') || v.lang.includes('CN'));
                if(!zhVoice) {
                    voiceStatus.innerText = "警告：未检测到中文语音包，读中文可能无声";
                    voiceStatus.classList.remove('hidden');
                } else {
                    voiceStatus.classList.add('hidden');
                }
            }
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();
        setTimeout(loadVoices, 500);
        loadErrors(); 

        // Helper to find best voice
        function getBestVoice(lang) {
            if (voices.length === 0) return null;

            if (lang === 'en' && enVoiceSelect.value) {
                return voices.find(v => v.name === enVoiceSelect.value) || null;
            }
            if (lang === 'zh' && zhVoiceSelect.value) {
                return voices.find(v => v.name === zhVoiceSelect.value) || null;
            }

            let bestVoice = null;
            if (lang === 'en') {
                const usVoices = voices.filter(v => v.lang === 'en-US' || v.lang.includes('en-US'));
                if (usVoices.length > 0) {
                    bestVoice = usVoices.find(v => v.name.includes('Google') || v.name.includes('Microsoft')) || usVoices[0];
                } else {
                    bestVoice = voices.find(v => v.lang.startsWith('en'));
                }
            } else if (lang === 'zh') {
                const cnVoices = voices.filter(v => v.lang === 'zh-CN' || v.lang.includes('zh-CN'));
                if (cnVoices.length > 0) {
                    bestVoice = cnVoices.find(v => v.name.includes('Google') || v.name.includes('Microsoft')) || cnVoices[0];
                } else {
                    bestVoice = voices.find(v => v.lang === 'zh');
                }
            }
            return bestVoice;
        }
        
        function testSelectedVoices() {
            synth.cancel();
            
            const enText = "Hello, this is a test.";
            const zhText = "你好，这是一个测试。";
            
            const utterEn = new SpeechSynthesisUtterance(enText);
            utterEn.lang = 'en-US';
            const enVoice = getBestVoice('en');
            if(enVoice) utterEn.voice = enVoice;
            
            const utterZh = new SpeechSynthesisUtterance(zhText);
            utterZh.lang = 'zh-CN';
            const zhVoice = getBestVoice('zh');
            if(zhVoice) utterZh.voice = zhVoice;
            
            synth.speak(utterEn);
            synth.speak(utterZh);
        }

        function getWeightedRandomList(n) {
            const errorItems = fullVocabulary.filter(item => errorList.includes(item.en));
            const normalItems = fullVocabulary.filter(item => !errorList.includes(item.en));
            const shuffledNormal = [...normalItems].sort(() => 0.5 - Math.random());
            
            let finalSelection = [];
            finalSelection = [...errorItems];
            
            const slotsNeeded = n - finalSelection.length;
            if (slotsNeeded > 0) {
                finalSelection = finalSelection.concat(shuffledNormal.slice(0, slotsNeeded));
            } else {
                finalSelection = finalSelection.sort(() => 0.5 - Math.random()).slice(0, n);
            }
            
            return finalSelection.sort(() => 0.5 - Math.random());
        }

        function populateWordList(items) {
            wordListBody.innerHTML = '';
            items.forEach((item, index) => {
                const isError = errorList.includes(item.en);
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                
                const errorBadge = isError ? '<span class="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full font-bold">错题</span>' : '';
                const unitBadge = `<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold">${item.unit}</span>`;

                tr.innerHTML = `
                    <td class="p-2 text-gray-500">${index + 1}</td>
                    <td class="p-2">${unitBadge}</td>
                    <td class="p-2 font-medium">
                        ${item.en}
                    </td>
                    <td class="p-2">${item.zh}</td>
                    <td class="p-2">${errorBadge}</td>
                `;
                wordListBody.appendChild(tr);
            });
        }

        function startDictation() {
            if(voices.length === 0) loadVoices();

            stopDictation(false); 
            
            const modeRadios = document.getElementsByName('mode');
            for(const radio of modeRadios) {
                if(radio.checked) dictationMode = radio.value;
            }

            // Read dynamic count
            const selectedCount = parseInt(itemCountSelect.value);
            const count = Math.min(selectedCount, fullVocabulary.length);
            currentList = getWeightedRandomList(count);
            populateWordList(currentList);

            startBtn.classList.add('hidden');
            activeControls.classList.remove('hidden');
            statusArea.classList.remove('hidden');
            wordListArea.classList.add('hidden'); 
            toggleListBtn.classList.remove('hidden');
            
            currentIndex = 0;
            isPlaying = true;
            isPaused = false;
            
            processQueue();
        }

        function updateProgress() {
            progressText.innerText = `${currentIndex + 1} / ${currentList.length}`;
            const pct = ((currentIndex) / currentList.length) * 100;
            progressBar.style.width = `${pct}%`;
        }
        
        function navigate(direction) {
            if (!isPlaying) return;
            
            // direction: -1 for prev, 1 for next
            const newIndex = currentIndex + direction;
            
            if (newIndex < 0) {
                 // Already at start
                 return;
            }
            
            if (newIndex >= currentList.length) {
                // At end, maybe finish? Or just stop.
                finishDictation();
                return;
            }

            // Stop current speech and timeouts
            synth.cancel();
            clearAllTimeouts();
            
            // Update index
            currentIndex = newIndex;
            
            // Reset pause state if paused
            if (isPaused) {
                isPaused = false;
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停';
                pauseBtn.classList.remove('bg-yellow-100', 'text-yellow-800');
                pauseBtn.classList.add('bg-white', 'text-gray-800');
            }
            
            // Restart queue at new index
            processQueue();
        }

        function markCurrentAsError() {
            if (currentIndex >= currentList.length) return;
            
            const currentItem = currentList[currentIndex];
            if (!errorList.includes(currentItem.en)) {
                errorList.push(currentItem.en);
                saveErrors();
                
                markErrorBtn.innerHTML = '<i class="fas fa-check"></i> 已加入错题本';
                markErrorBtn.classList.remove('btn-warning');
                markErrorBtn.classList.add('bg-gray-400', 'text-white', 'cursor-not-allowed');
            }
        }
        
        function resetMarkButton() {
            if (currentIndex < currentList.length) {
                const item = currentList[currentIndex];
                if (errorList.includes(item.en)) {
                    markErrorBtn.innerHTML = '<i class="fas fa-check"></i> 这是一个错题';
                    markErrorBtn.classList.remove('btn-warning');
                    markErrorBtn.classList.add('bg-gray-400', 'text-white');
                } else {
                    markErrorBtn.innerHTML = '<i class="far fa-frown"></i> 太难了 / 记不住';
                    markErrorBtn.classList.add('btn-warning');
                    markErrorBtn.classList.remove('bg-gray-400', 'text-white', 'cursor-not-allowed');
                }
            }
        }

        function speakText(text, lang, callback) {
            if (!isPlaying) return;
            
            // Fix for Chrome bug where speech stops working
            if (synth.paused) {
                synth.resume();
            }

            synth.cancel();

            // Small delay to allow cancel to take effect effectively
            setTimeout(() => {
                if (!isPlaying) return;

                const utterance = new SpeechSynthesisUtterance(text);
                
                // GC Protection
                window.speechUtterances.push(utterance);
                
                const langCode = lang === 'en' ? 'en-US' : 'zh-CN';
                utterance.lang = langCode;
                utterance.rate = 0.9;

                const targetVoice = getBestVoice(lang);
                if (targetVoice) utterance.voice = targetVoice;

                const cleanup = () => {
                    const index = window.speechUtterances.indexOf(utterance);
                    if (index > -1) {
                        window.speechUtterances.splice(index, 1);
                    }
                };

                utterance.onend = () => {
                    cleanup();
                    if(callback) callback();
                };

                utterance.onerror = (e) => {
                    console.warn('Speech warning (retrying or skipping):', e);
                    // Don't treat as fatal, just cleanup and move on
                    cleanup();
                    if(callback) callback(); 
                };

                try {
                    synth.speak(utterance);
                    playingIcon.classList.remove('hidden');
                } catch (err) {
                    console.error("Speech synthesis failed directly:", err);
                    cleanup();
                    if(callback) callback();
                }
            }, 100);
        }

        function processQueue() {
            if (!isPlaying) return;
            if (isPaused) return;

            if (currentIndex >= currentList.length) {
                finishDictation();
                return;
            }

            const item = currentList[currentIndex];
            updateProgress();
            resetMarkButton(); 
            
            // Update Prev/Next button states
            prevBtn.disabled = currentIndex === 0;
            prevBtn.classList.toggle('opacity-50', currentIndex === 0);
            prevBtn.classList.toggle('cursor-not-allowed', currentIndex === 0);
            
            let currentLang = dictationMode;
            if (dictationMode === 'mixed') {
                currentLang = Math.random() < 0.5 ? 'en' : 'zh';
            }

            const textToRead = currentLang === 'en' ? item.en : item.zh;
            
            let readCount = 0;

            const readLoop = () => {
                if(!isPlaying) return;
                if(isPaused) return;

                const modeText = currentLang === 'en' ? "英文" : "中文";
                const displayEn = item.en.length > 20 ? item.en.substring(0, 20) + "..." : item.en;
                statusMessage.innerText = `[${modeText}] 正在读第 ${readCount + 1} 遍...`;

                // Detect if it is a sentence to adjust delay
                // Sentences typically end with punctuation in this dataset or are simply longer
                const isSentence = /[.?!。？！]$/.test(item.en) || item.en.split(' ').length > 3;
                const repeatInterval = isSentence ? 3000 : 1000;

                speakText(textToRead, currentLang, () => {
                    playingIcon.classList.add('hidden');
                    readCount++;
                    
                    if (readCount < REPEATS) {
                        const id = setTimeout(readLoop, repeatInterval);
                        timeoutIds.push(id);
                    } else {
                        statusMessage.innerText = "等待下一个...";
                        const id = setTimeout(() => {
                            currentIndex++;
                            processQueue();
                        }, INTERVAL_NEXT);
                        timeoutIds.push(id);
                    }
                });
            };

            readLoop();
        }

        function togglePause() {
            if (!isPlaying) return;
            
            if (isPaused) {
                isPaused = false;
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停';
                pauseBtn.classList.remove('bg-yellow-100', 'text-yellow-800');
                pauseBtn.classList.add('bg-white', 'text-gray-800');
                synth.resume();
                processQueue(); 
            } else {
                isPaused = true;
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> 继续';
                pauseBtn.classList.remove('bg-white', 'text-gray-800');
                pauseBtn.classList.add('bg-yellow-100', 'text-yellow-800');
                synth.cancel(); 
                clearAllTimeouts();
                playingIcon.classList.add('hidden');
                statusMessage.innerText = "已暂停";
            }
        }

        function stopDictation(resetUI = true) {
            isPlaying = false;
            isPaused = false;
            synth.cancel();
            clearAllTimeouts();
            playingIcon.classList.add('hidden');
            window.speechUtterances = [];

            if (resetUI) {
                startBtn.classList.remove('hidden');
                activeControls.classList.add('hidden');
                statusArea.classList.add('hidden');
                statusMessage.innerText = "准备开始...";
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> 暂停';
                wordListArea.classList.remove('hidden');
                populateWordList(currentList); 
            }
        }

        function finishDictation() {
            stopDictation(true);
            statusMessage.innerText = "听写完成！";
            alert("听写完成！请检查你的答案。");
            wordListArea.classList.remove('hidden');
            wordListArea.scrollIntoView({ behavior: 'smooth' });
        }

        function clearAllTimeouts() {
            timeoutIds.forEach(id => clearTimeout(id));
            timeoutIds = [];
        }

        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isPlaying && !isPaused) {
                togglePause();
            }
        });

    </script>
</body>
</html>
